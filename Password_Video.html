<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Dune Password Security</title>
    <style>
        button:disabled {
            background-color: grey;
            color: white;
            cursor: not-allowed;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
        .hidden {
            display: none;
        }
        .quiz-form {
            max-width: 600px;
            margin: auto;
            font-family: Arial, sans-serif;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .question {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
    </style>
    <script src="scormfunctions.js"></script>
    <script src="quiz_functions.js"></script>
</head>
<body>
    <h1>Dune Password Security</h1>

    <!-- Video Section -->
    <div id="video-section">
    <video id="passwords_video" width="640" height="360" controls>
        <source src="passwords.mp4" type="video/mp4" />
        Your browser does not support the video tag.
    </video>
    <br />
    <p>Watch the above video on password security from start to finish to continue.</p>
    <br /><br />
    <button id="next_button" disabled>Next: Knowledge Check</button>
    </div>

    <!-- Quiz Section -->
    <div id="quiz-section" class="hidden">
    <h2>Dune Password Security Quiz</h2>
    <form id="quiz_form" class="quiz-form">
        <!-- Quiz questions will be rendered by quizFuncs.renderQuestions() -->
    </form>
    </div>

    <script>
        window.onload = function() {
            ScormProcessInitialize();
            // ScormProcessSetValue("cmi.suspend_data", ""); //clear suspend data
            const video = document.getElementById("passwords_video");
            const nextButton = document.getElementById("next_button");
            const quizSection = document.getElementById("quiz-section");
            const videoSection = document.getElementById("video-section");
            
            let suspendData = ScormProcessGetValue("cmi.suspend_data");
            let vid_status = {};
            //check suspendData to see if video already completed
                if (suspendData) {
                    try {
                        vid_status = JSON.parse(suspendData);
                    } catch (e) {
                        console.error("Error parsing suspend data:", e);
                    }
                }
            if (vid_status.videoCompleted) {
                alert("Video already completed in previous session");
                nextButton.disabled = false;
            }

            let max_time_watched = 0;
            // video.controls = false; 
            video.addEventListener("timeupdate", () => {
                if (!video.seeking && video.currentTime > max_time_watched) {
                    max_time_watched = video.currentTime;
                }
            });
            // Prevent seeking ahead
            video.addEventListener("seeking", () => {
                if (video.currentTime > max_time_watched + 0.5) {
                    video.currentTime = max_time_watched;
                }
            });
            // Disable arrow key seeking when video is focused
            video.addEventListener("keydown", (e) => {
                if (["ArrowLeft", "ArrowRight"].includes(e.key)) {
                    e.preventDefault();
                }
            });
            // When video ends, enable the Next button
            video.addEventListener("ended", () => {
                alert("Video completed! You can now proceed to the Knowledge Check.");
                ScormProcessSetValue("cmi.completion_status", "incomplete");
                ScormProcessSetValue("cmi.progress_measure", 0.5);
                // Save video completion status
                let suspendData = ScormProcessGetValue("cmi.suspend_data");
                let dataObj = {};
                try {
                    dataObj = JSON.parse(suspendData);
                } catch (e) {
                    // Ignore error
                }
                dataObj.videoCompleted = true;
                ScormProcessSetValue("cmi.suspend_data", JSON.stringify(dataObj));
                nextButton.disabled = false;
            });

            nextButton.onclick = function() {
                videoSection.classList.add("hidden");
                quizSection.classList.remove("hidden");

                // Initialize quiz state and render questions
                quizFuncs.init();
            };

            let videoStartTime = new Date();
            window.addEventListener("beforeunload", () => {
                let endTime = new Date();
                let elapsed = (endTime - videoStartTime) / 1000;

                let suspendData = ScormProcessGetValue("cmi.suspend_data");
                let dataObj = {};
                try {
                dataObj = JSON.parse(suspendData);
                } catch (e) {
                // Ignore error
                }
                dataObj.time_elapsed = (dataObj.time_elapsed || 0) + elapsed;
                ScormProcessSetValue("cmi.suspend_data", JSON.stringify(dataObj));
                ScormProcessCommit();
            });
        };

        window.onunload = function() {
            ScormProcessTerminate();
        };

        window.onbeforeunload = function() {
            let end_time = new Date()
            let suspendData = ScormProcessGetValue("cmi.suspend_data");
            let dataObj = {};
            try {
                dataObj = JSON.parse(suspendData);
            } catch (e) {
                console.warn("Error parsing suspend data:", e);
            }
            dataObj.time_elapsed = (end_time - start_time) / 1000; //time in seconds
            ScormProcessSetValue("cmi.suspend_data", JSON.stringify(dataObj));
            ScormProcessTerminate();
        };

    </script>
</body>
</html>
